<html>
<head>
<script>
var dots = new Array();
var palette = new Array("#000000", "#ffffff","#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff","#ff9900","#99ff00","#0099ff","#9900ff");
var curpal = 1;
var tools = new Array("pencil", "marker", "rect", "shell", "fill");
var curtool = 0;
var shape = '240mm';
var canvaswidth = 500;
var canvasheight = 500;
var centerx = 250;
var centery = 250;
var shellwidth = 20;
var dotradius = 6;
var shellNums = new Array(48,44,40,32,28,24,20,12,6,1);
var shellPos = new Array();
var paint = false;
var cursorcolor = "#FF0000";
var startrectx = 0;
var endrectx = 0;
var startrecty = 0;
var endrecty = 0;


function changeTool(t) {
	curtool=t;
	console.log("Changing tool: "+t);
	document.getElementById('toolbarimg').style.backgroundPosition = t*30+" 0";
}

function changepal(num) {
	curpal = num;
	document.getElementById('paledit').value = palette[curpal];
	for(i=0;i<palette.length;i++){
		document.getElementById('pal'+i).style.border = (i==curpal) ? "1px solid #FF0000" : "1px solid #000000";
		}
		console.log("changing palette");
}

function editpal(e) {

        if (e.keyCode == 13){
			var patt = new RegExp("#[0-9|a-f|A-F]{6}");
			if (patt.test(document.getElementById('paledit').value)) {
                palette[curpal] = document.getElementById('paledit').value;
				document.getElementById('paledit').blur();
				document.getElementById('pal'+curpal).style.backgroundColor = palette[curpal];
				redraw();
				}
			}
        return false;

}

function redraw() {
	ctx.fillStyle = "#000000";
	ctx.rect(0,0,canvaswidth,canvasheight);
	ctx.fill();
	ctx.fillStyle = "#333333";
	ctx.beginPath();
	switch (shape) {
		case '240mm':
			ctx.arc(centerx,centery,shellNums.length*shellwidth,0*Math.PI,2*Math.PI);
		break;
		case '8x32':
			ctx.rect(10,10,canvaswidth-20, canvasheight-20);
		break;
		}
	ctx.fill();
	for(i=0;i<dots.length;i++){
		drawDot(shellPos[i][0],shellPos[i][1],palette[dots[i]]);
	}
	var ac = "const uint32_t   pal[12] PROGMEM = {\n  \t\t";
	for(i=0;i<palette.length;i++){
		if (i>0)
			ac += ',';
		ac += palette[i];
	}
	ac = ac.replace(/#/ig, "0x");
	ac += "\n\t};\n";
	ac += "const byte dots[] PROGMEM = {\n\t\t";
	for (i=0;i<dots.length;i++){
		if (i>0)
			ac += ",";
		ac += dots[i];
	}
	ac += "\n\t};\n";
	ac += "for (int i=0;i<"+dots.length+";i++){\n";
	ac +="\tstrip.setPixelColor(i, palette[dots[i]]);\n";
	ac +="}\n";
	ac +="strip.show();\n";
	ac +="delay(20);\n";
	document.getElementById("arduinocode").innerText = ac;
}

function drawDot (x, y, color) {
	ctx.fillStyle=color;
	ctx.beginPath();
	ctx.arc(x,y,dotradius,0,2*Math.PI);
	ctx.fill();
	return 1;
}

function addClick(x,y) {
	if (paint) {
		switch (tools[curtool]) {

			case 'pencil':
				for(i=0;i<dots.length;i++){
					if (Math.abs(shellPos[i][0] - x) < 6 && Math.abs(shellPos[i][1] - y) < 6) {
						dots[i] = curpal;
					}
				}
			break;
			case 'marker':
				for(i=0;i<dots.length;i++){
					if (Math.sqrt(Math.pow(Math.abs(shellPos[i][0] - x),2) + Math.pow(Math.abs(shellPos[i][1] - y),2)) < 30) {
						dots[i] = curpal;
					}
				}
			break;
			case 'rect':
			
			break;
			case 'shell':
				if (shape != '240mm')
					break;
				disttocenter = Math.sqrt(Math.pow(Math.abs(x-centerx),2) + Math.pow(Math.abs(y-centery),2));
				//console.log(disttocenter);
				countit = 0;
				for(shell=0;shell<shellNums.length;shell++) {
						if (Math.abs((shellNums.length-shell-1) * shellwidth - disttocenter) < 6) {
						//console.log("Close"+shell);
							for (i=0;i<shellNums[shell];i++){
								dots[countit+i] = curpal;
								//console.log(countit+i);
							}
						}
						countit += shellNums[shell];
					}		
			break;
			case 'fill':
				for (i=0; i<dots.length; i++) {
					dots[i] = curpal;
				}
			break;
		}
	}
	redraw();
	drawcursor(x,y);
	
}

function drawcursor(x,y) {
	switch (tools[curtool]) {
		case 'pencil':
			ctx.strokeStyle=cursorcolor;
			ctx.beginPath();
			ctx.arc(x,y,dotradius,0,2*Math.PI);
			ctx.stroke();
		break;
		case 'marker':
			ctx.strokeStyle=cursorcolor;
			ctx.beginPath();
			ctx.arc(x,y,26,0,2*Math.PI);
			ctx.stroke();
		break;
		case 'rect':
			ctx.strokeStyle=cursorcolor;
			ctx.beginPath();
			ctx.moveTo(x-8,y);
			ctx.lineTo(x+8, y);
			ctx.moveTo(x,y-8);
			ctx.lineTo(x,y+8);
			ctx.stroke();	
			if (paint) {
				ctx.strokeStyle="#FFFFFF";
				ctx.beginPath();
				ctx.moveTo(startrectx, startrecty);
				ctx.lineTo(startrectx, y);
				ctx.lineTo(x, y);
				ctx.lineTo(x, startrecty);
				ctx.lineTo(startrectx, startrecty);
				ctx.stroke();
			}
		break;
		case 'shell':

		break;
		case 'fill':

		break;
	}
}

function drawrect(x1,y1,x2,y2) {
console.log ("rect");
	if (x1>x2) {
		var tmp = x2;
		x2=x1;
		x1=tmp;
	}
	if (y1>y2) {
		var tmp = y2;
		y2=y1;
		y1=tmp;
	}
	for(i=0;i<dots.length;i++){
		if (shellPos[i][0] >= x1 && shellPos[i][0] <= x2 && shellPos[i][1] >= y1 && shellPos[i][1] <= y2) {
			dots[i] = curpal;
		}
	}
}

//initialize the drawing tool
function setShape() {
	switch(location['search']) {
		case "?240mm":
			shape = '240mm';
			canvaswidth = 500;
			canvasheight = 500;
			centerx = 250;
			centery = 250;
			shellwidth = 20;
			dotradius = 6;
			shellNums = new Array(48,44,40,32,28,24,20,12,6,1);
			/* Initialize the pixel positions */
			var countit = 0;
			for(shell=0;shell<shellNums.length;shell++) {
				for(pos=0;pos<shellNums[shell];pos++){
					var theta = 2*Math.PI/shellNums[shell]*pos - .5*Math.PI;
					shellPos[countit] = new Array(centerx+(Math.cos(theta)*((9-shell)*shellwidth)),centery+(Math.sin(theta)*((9-shell)*shellwidth)));
					dots[countit] = 0;
					countit++;

				}
			}
		break;
		case "?8x32":
			shape = '8x32';
			canvaswidth = 500;
			canvasheight = 139;
			document.getElementById("myCanvas").height = canvasheight;
			document.getElementById("myCanvas").style.height = canvasheight;
			centerx = 250;
			centery = 250;
			shellwidth = 15;
			dotradius = 5;
			/* Initialize the pixel positions */
			var countit = 0;
			startx = 17;
			starty = 17;
			var thisx = 0;
			var thisy = 0;
			for(x=0;x<32;x++){
				for(y=0;y<8;y++) {
					thisy = (x%2) ? y*shellwidth : (7-y)*shellwidth; //rows alternate left to right and right to left
					thisx = x*shellwidth;
					shellPos[countit] = new Array(thisx+startx,thisy+starty);
					dots[countit] = 0;
					countit++;
				}
			}
		break;
	}
}

</script>
</head>

<body onload="changepal(1); setShape(); redraw()">
<h1 style="font-size:12pt; font-family:sans-serif">DotStar Drawing Tool (<a href="?240mm">240mm disk</a> | <a href="?8x32">8x32 panel</a>)</h1>
<canvas  width = 500 height = 500 id="myCanvas" style="width:500; height:500; background-color:#000000; margin-bottom:10px"></canvas><br>
<div id = 'toolbar' style="margin-right:30px; float:left">
<img src="dotstar_toolbar.png" usemap="toolmap" style="background-image:url('dotstar_toolbar_selector.png'); background-repeat:no-repeat; background-position: 0 0" id="toolbarimg">
<map name="toolmap">
	<area shape="rect" coords="0,0,29,30" href="javascript:changeTool(0);" alt="Pencil">
	<area shape="rect" coords="31,0,60,30" href="javascript:changeTool(1);" alt="Marker">
	<area shape="rect" coords="60,0,89,30" href="javascript:changeTool(2);" alt="Rect">
	<area shape="rect" coords="90,0,119,30" href="javascript:changeTool(3);" alt="Shell">
	<area shape="rect" coords="120,0,150,30" href="javascript:changeTool(4);" alt="Fill">
</map>
</div>
<script>
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");

//draw the palette
for(i=0;i<palette.length;i++){
	document.write("<div style='float:left; height:20; width:20; border:1px solid #000000; background-color:"+palette[i]+"' id='pal"+i+"' onclick='changepal("+i+")'></div>");
}
</script>
<input id="paledit" style="font-size:8pt; font-family:sans-serif; width:50; margin-left:6px" maxlength="7" onkeypress="editpal(event)">

<script>

//Set up the drawing function
document.getElementById('myCanvas').onmousedown = function(e){
	var mouseX = e.pageX - this.offsetLeft;
	var mouseY = e.pageY - this.offsetTop;
	paint = true;
	if (tools[curtool] == "rect") {
		startrectx = e.pageX - this.offsetLeft;
		startrecty = e.pageY - this.offsetTop;
	}  
	addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
};

document.getElementById('myCanvas').onmousemove = function(e){
  addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
};

document.getElementById('myCanvas').onmouseup = function(e){
	if (tools[curtool] == "rect") {
		drawrect(startrectx, startrecty, e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
	}  
	paint = false;
};

</script>
<br clear="all"><textarea style="width:500; height:200; font-family:Sans-serif; font-size:8pt; color:#666666" id="arduinocode"></textarea>
</body>
</html>